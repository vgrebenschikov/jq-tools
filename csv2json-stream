#!/usr/bin/jq -Rn -r -f 

def objectify(headers):
  def tonumberq: tonumber? // .;
  . as $in
  | reduce range(0; headers|length) as $i ({}; .[headers[$i]] = ($in[$i] | tonumberq) );

def trim:
  sub("^ +";"") | sub(" +$";"") | sub("^\"";"") | sub("\"$";"") | gsub("\"\"";"\"");

def csvsplit:
  [
    sub("\n";"") | sub("\r";"")
    | scan("(\"(?:[^\"]*(?:\"\"[^\"]*)*)\"|(?:[^,]+)|(?<=,)(?=,))")
    | if . == "" then . else .[0] end
  ];

def csv2table:
  csvsplit | map(trim);

def headers:
  csv2table | map(gsub("\"";""));  # additional cut quotes from header due to bug in first regexp match

def csv2json:
  first(inputs) | headers as $headers |
  first(inputs) | csv2table | objectify($headers) | tostring,
  "," + (inputs | select(length > 0) | csv2table | objectify($headers) | tostring);


"[", csv2json, "]"
